# **EC2 (Elastic Compute Cloud)**

---

## **1. EC2 Overview**

Amazon EC2 (Elastic Compute Cloud) is the backbone of AWS compute ‚Äî it provides **virtual machines (VMs)** in the cloud that you can configure, launch, and scale as needed.

- **Elastic:** Scale capacity up or down as workloads change.
    
- **Compute:** You get CPU, memory, networking, and storage on demand.
    
- **Cloud:** You pay only for what you use ‚Äî no upfront hardware.
    

### **Key Features**

|Component|Description|
|---|---|
|**AMI (Amazon Machine Image)**|Blueprint defining OS, software, and configurations.|
|**Instance Type**|Hardware configuration: vCPU, RAM, and network performance.|
|**Key Pair**|SSH authentication credentials for secure login.|
|**Security Group**|Virtual firewall controlling inbound/outbound traffic.|
|**EBS Volume**|Persistent block-level storage that survives restarts.|
|**IAM Role**|Grants AWS API access securely without access keys.|

### **Common Use Cases**

- Hosting APIs, dashboards, or web apps.
    
- Data pipelines and ETL workloads (custom Spark/Polars).
    
- Distributed computation (e.g., ML training, Kafka clusters).
    
- Self-managed orchestration tools like Airflow or Grafana.
    

### **Instance Families**

|Family|Focus|Examples|
|---|---|---|
|**t2**, **t3**|General-purpose, burstable|Free-tier eligible, dev/testing|
|**m5**, **m6g**|Balanced compute and memory|Production workloads|
|**c5**, **c6i**|Compute-optimized|CPU-heavy ETL or analytics|
|**r5**, **r6g**|Memory-optimized|In-memory DBs or caching|
|**g4**, **p3**|GPU instances|Deep learning, rendering|

---

## **2. Launching and Managing Instances**

EC2 can be controlled from both the console and CLI. Below are essential CLI commands with explanations.

---

### **Step 1 ‚Äì Find an Amazon Linux 2 AMI**

```bash
aws ec2 describe-images \
  --owners amazon \
  --filters "Name=name,Values=amzn2-ami-hvm-*-x86_64-gp2" \
  --region ap-south-1 \
  --query 'Images[*].[ImageId,Name,CreationDate]' \
  --output table
```

üîπ **Concept:** Returns available AMIs owned by AWS.  
Amazon Linux 2 is commonly used because it‚Äôs lightweight, secure, and well-supported.

---

### **Step 2 ‚Äì Create a Key Pair**

```bash
aws ec2 create-key-pair --key-name MyKeyPair \
  --query 'KeyMaterial' --output text > MyKeyPair.pem
chmod 400 MyKeyPair.pem
```

üîπ **Concept:**  
Key pairs are used for SSH authentication (not passwords).  
Private key (`.pem`) stays with you; AWS stores the public half.

---

### **Step 3 ‚Äì Create a Security Group**

```bash
aws ec2 create-security-group \
  --group-name MySG \
  --description "My EC2 security group" \
  --vpc-id vpc-xxxxxxxx --region ap-south-1
```

üîπ **Concept:**  
A **Security Group** acts as a **stateful firewall**.  
Stateful means if inbound traffic is allowed, response traffic is automatically allowed.

**Allow inbound SSH:**

```bash
aws ec2 authorize-security-group-ingress \
  --group-name MySG \
  --protocol tcp --port 22 --cidr 0.0.0.0/0
```

‚ö†Ô∏è **Security Tip:** Restrict `--cidr` to your IP for security, not `0.0.0.0/0`.

---

### **Step 4 ‚Äì Launch an Instance**

```bash
aws ec2 run-instances \
  --image-id ami-0abcdef1234567890 \
  --count 1 --instance-type t2.micro \
  --key-name MyKeyPair --security-groups MySG \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=EC2-DE-Node}]'
```

üîπ **Concept:**  
Launches one EC2 instance (`t2.micro` free-tier).  
Tags help with cost tracking, automation, and identification.

---

### **Step 5 ‚Äì List and Monitor Instances**

```bash
aws ec2 describe-instances \
  --query "Reservations[].Instances[].{ID:InstanceId,Name:Tags[?Key=='Name']|[0].Value,State:State.Name,Type:InstanceType,PublicIP:PublicIpAddress}" \
  --output table
```

üîπ **Concept:**  
Displays instance details ‚Äî ID, state, name, and public IP.  
Useful for quick inventory checks or scripting.

---

## **3. Connecting to EC2**

Once running, connect via SSH.

**Set file permissions:**

```bash
chmod 400 MyKeyPair.pem
```

**SSH login:**

```bash
ssh -i "MyKeyPair.pem" ec2-user@<public-ip>
```

**Inside EC2 (Amazon Linux 2 example):**

```bash
sudo yum update -y
sudo yum install python3 -y
python3 --version
```

---

## **4. IAM Role Integration**

Attaching IAM roles lets your EC2 access AWS resources securely ‚Äî e.g., S3, Glue, DynamoDB ‚Äî **without storing credentials**.

---

### **Create Role (Trust Policy)**

```bash
aws iam create-role \
  --role-name EC2S3AccessRole \
  --assume-role-policy-document file://trust-policy.json
```

**trust-policy.json**

```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": {"Service": "ec2.amazonaws.com"},
    "Action": "sts:AssumeRole"
  }]
}
```

üîπ **Concept:** Defines **who can assume the role** ‚Äî here, EC2.

---

### **Attach Permissions**

```bash
aws iam attach-role-policy \
  --role-name EC2S3AccessRole \
  --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
```

üîπ **Concept:** Attaches AWS-managed S3 policy to the role.

---

### **Create Instance Profile**

```bash
aws iam create-instance-profile --instance-profile-name EC2S3AccessProfile
aws iam add-role-to-instance-profile \
  --instance-profile-name EC2S3AccessProfile \
  --role-name EC2S3AccessRole
```

üîπ **Concept:**  
An **Instance Profile** is a container for the IAM Role ‚Äî EC2 uses it to automatically fetch temporary credentials.

---

### **Attach Role to Instance**

```bash
aws ec2 associate-iam-instance-profile \
  --instance-id i-0abcd1234ef56789 \
  --iam-instance-profile Name=EC2S3AccessProfile
```

‚úÖ EC2 can now call AWS APIs securely (e.g., `aws s3 ls`) without running `aws configure`.

---

## **5. Data Engineering Use Cases**

|Use Case|When to Use EC2|Example Workflow|
|---|---|---|
|**Custom ETL**|Glue/Lambda lacks dependencies (e.g., TensorFlow, PyArrow).|S3 ‚Üí EC2 process ‚Üí Upload back to S3|
|**Long-running Jobs**|Heavy data prep or model training.|Airflow triggers EC2 job via SSH|
|**Hybrid Architecture**|Combine EC2 with Glue, Redshift, or Grafana.|S3 ‚Üí EC2 ‚Üí S3 (clean data) ‚Üí Glue crawler|

---

### **Example: Simple ETL**

```bash
aws s3 cp s3://data-raw/flights.csv flights.csv
python3 transform.py
aws s3 cp processed.csv s3://data-clean/processed.csv
```

**Automate** with:

- **Airflow DAG** ‚Üí using SSH or EC2Operator.
    
- **AWS Step Functions** ‚Üí start, process, stop instance.
    

---

## **6. Exposing Services (Grafana, Airflow, Streamlit)**

If running Dockerized DE stack (Airflow, MinIO, Postgres, Grafana) on EC2:

**Open required ports:**

```bash
aws ec2 authorize-security-group-ingress \
  --group-id sg-xxxxxxxx \
  --protocol tcp --port 3000 --cidr 0.0.0.0/0
```

**Access:**  
`http://<public-ip>:3000`

**Optional Nginx Reverse Proxy:**

```bash
sudo yum install nginx -y
sudo systemctl start nginx
```

Forward port `80 ‚Üí 3000` and secure with Let‚Äôs Encrypt SSL for production.

---

## **7. Storage Management (EBS)**

### **Attach Volume**

```bash
aws ec2 attach-volume \
  --volume-id vol-0abc123 \
  --instance-id i-0abc123 \
  --device /dev/sdf
```

### **List Volumes**

```bash
aws ec2 describe-volumes \
  --query "Volumes[*].{ID:VolumeId,Size:Size,State:State,AZ:AvailabilityZone}" \
  --output table
```

**Concepts:**

- **EBS (Elastic Block Store):** Persistent storage; survives instance stop/start.
    
- **Snapshots:** Backups stored in S3; can recreate volumes anytime.
    
- **IOPS:** Measure of disk performance, critical for DB or ETL workloads.
    

---

## **8. Security Best Practices**

1. Restrict SSH to your IP ‚Äî avoid `0.0.0.0/0`.
    
2. Use **roles**, not access keys, for AWS API calls.
    
3. Apply **least privilege** principle in IAM.
    
4. Tag all resources for cost tracking:
    
    ```bash
    aws ec2 create-tags \
      --resources i-0abcd1234 \
      --tags Key=Owner,Value=Asad Key=Project,Value=DataPipeline
    ```
    
5. Use CloudWatch for monitoring CPU/memory and CloudTrail for activity logs.
    

---

## **9. Cost Optimization**

|Strategy|Description|
|---|---|
|**Free-tier instances**|Use `t2.micro` / `t3.micro` for light workloads.|
|**Auto-stop scripts**|Stop instances during idle hours to avoid charges.|
|**Spot instances**|Up to 90% cheaper ‚Äî great for batch ETL.|
|**Right-sizing**|Monitor CPU & memory metrics; downgrade underutilized nodes.|
|**Avoid idle EBS/IPs**|Unattached storage and Elastic IPs still incur costs.|

### **Example ‚Äì Spot Instance Request**

```bash
aws ec2 request-spot-instances \
  --spot-price "0.01" \
  --instance-count 1 \
  --type "one-time" \
  --launch-specification file://spot-launch.json
```

---

### **EC2 Lifecycle Summary**

|Step|Command|Description|
|---|---|---|
|Launch|`run-instances`|Create instance|
|Start/Stop|`start-instances` / `stop-instances`|Power control|
|Terminate|`terminate-instances`|Delete permanently|
|Tag|`create-tags`|Assign ownership and purpose|
|Monitor|`describe-instances`|View state, IP, etc.|
